test_that("FDate arith", {
	expect_equal(as.FDate("2000-2-28") + as.ddur("P0"), as.FDate(20000228L))
	expect_equal(as.FDate("2000-2-28") + as.ddur("P1D"), as.FDate(20000229L))
	expect_equal(as.FDate("2000-2-28") + as.ddur("P1W"), as.FDate("2000-03-06"))
	expect_equal(as.FDate("2000-2-28") + as.ddur("P-1D"), as.FDate("2000-02-27"))
	expect_equal(as.FDate("2000-2-28") + as.ddur("P-2W"), as.FDate("2000-02-14"))

	expect_equal(as.FDate("2000-2-29") + as.ddur("P1M"), as.FDate("2000-03-29"))
	expect_equal(as.FDate("2000-2-29") + as.ddur("P-1M"), as.FDate("2000-01-29"))
	expect_equal(as.FDate("2000-2-29") + as.ddur("P-13M"), as.FDate(19990129L))
	expect_equal(as.FDate("2000-2-29") + as.ddur("P1Y"), as.FDate(20010229L))
	expect_equal(format(as.FDate("2000-2-29") + as.ddur("P1Y")), format(as.FDate(20010228L)))
	expect_equal(as.FDate("2000-2-29") + as.ddur("P-1Y"), as.FDate(19990229L))
	expect_equal(format(as.FDate("2000-2-29") + as.ddur("P-1Y")), format(as.FDate(19990228L)))

	expect_equal(as.FDate("2000-1-31") + as.ddur("P1M"), as.FDate("2000-2-31"))
	expect_equal(as.FDate("2000-1-31") + as.ddur("P1M1D"), as.FDate("2000-03-01"))
	expect_equal(as.FDate("2000-1-31") + as.ddur("P3M"), as.FDate("2000-04-31"))
	expect_equal(format(as.FDate("2000-1-31") + as.ddur("P3M")), "2000-04-30")
	expect_equal(as.FDate("2000-1-31") + as.ddur("P3M2D"), as.FDate("2000-05-02"))
	expect_equal(as.FDate("2000-1-31") + as.ddur("P-2M"), as.FDate(19991131L))
	expect_equal(format(as.FDate("2000-1-31") + as.ddur("P-2M")), "1999-11-30")
	expect_equal(as.FDate("2000-1-31") + as.ddur("P-2M-1D"), as.FDate(19991130L))
	expect_equal(as.FDate("2000-1-31") + as.ddur("P1M-1D"), as.FDate(20000230L))
	expect_equal(format(as.FDate("2000-1-31") + as.ddur("P1M-1D")), "2000-02-29")
	expect_equal(as.FDate("2000-1-31") + as.ddur("P-2M1D"), as.FDate(19991201L))
	expect_true(is.na(as.FDate("2000-1-31") + as.ddur("XXX")))

	expect_equal(as.FDate("2000-2-28") + as.ddur("P0"), as.FDate("2000-02-28"))
	expect_equal(as.FDate("2000-2-28") + as.ddur("ON"), as.FDate("2000-02-29"))
	expect_equal(as.FDate("2000-2-28") + as.ddur("P1W"), as.FDate("2000-03-06"))
	expect_equal(as.FDate("2000-2-28") + as.ddur("-SN"), as.FDate("2000-02-25"))
	expect_equal(as.FDate("2000-2-28") + as.ddur("P-2W"), as.FDate("2000-02-14"))

	expect_equal(as.FDate("2000-1-31") + as.ddur("P1M"), as.FDate("2000-02-31"))
	expect_equal(as.FDate("2000-1-31") + as.ddur("P1M1D"), as.FDate("2000-03-01"))
	expect_equal(as.FDate("2000-1-31") + as.ddur("P3M"), as.FDate("2000-04-31"))
	expect_equal(as.FDate("2000-1-31") + as.ddur("P3M2D"), as.FDate("2000-05-02"))
	expect_equal(as.FDate("2000-1-31") + as.ddur("P-2M"), as.FDate("1999-11-31"))
	expect_equal(as.FDate("2000-1-31") + as.ddur("P-2M-1D"), as.FDate("1999-11-30"))
	expect_equal(as.FDate("2000-1-31") + as.ddur("P1M-1D"), as.FDate("2000-02-30"))
	expect_equal(as.FDate("2000-1-31") + as.ddur("P-2M1D"), as.FDate("1999-12-01"))
	expect_equal(as.FDate("2000-3-06") - as.ddur("P12D"), as.FDate("2000-2-23"))
	expect_equal(as.FDate("2000-3-06") + as.ddur("P-42D"), as.FDate("2000-1-24"))
})

test_that("FDate arith with auto-promotion", {
	expect_equal(as.FDate("2000-A") + as.ddur("ON"), as.FDate("2000-01-01"))
	expect_equal(as.FDate("2000-A") + as.ddur("P1M"), as.FDate("2000-G"))
	expect_equal(as.FDate("2000-A") + as.ddur("P5Y"), as.FDate("2005-A"))
	expect_equal(as.FDate("2000-A") - as.ddur("P5Y"), as.FDate("1995-A"))

	expect_equal(as.FDate("2000-S1") + as.ddur("ON"), as.FDate("2000-01-01"))
	expect_equal(as.FDate("2000-S1") + as.ddur("P1M"), as.FDate("2000-02"))
	expect_equal(as.FDate("2000-S1") + as.ddur("P6M"), as.FDate("2000-S2"))
	expect_equal(as.FDate("2000-S1") + as.ddur("P6Y"), as.FDate("2006-S1"))
	expect_equal(as.FDate("2000-S2") + as.ddur("P6M"), as.FDate("2001-S1"))
	expect_equal(as.FDate("2000-S1") + as.ddur("P-6M"), as.FDate("1999-S2"))
	expect_equal(as.FDate("2000-S2") - as.ddur("P6M"), as.FDate("2000-S1"))

	expect_equal(as.FDate("2000-Q2") + as.ddur("ON"), as.FDate("2000-04-01"))
	expect_equal(as.FDate("2000-Q2") + as.ddur("P1M"), as.FDate("2000-K"))
	expect_equal(as.FDate("2000-Q2") + as.ddur("P6M"), as.FDate("2000-Q4"))
	expect_equal(as.FDate("2000-Q2") + as.ddur("P9M"), as.FDate("2001-Q1"))
	expect_equal(as.FDate("2000-Q2") - as.ddur("P9M"), as.FDate("1999-Q3"))
	expect_equal(as.FDate("2000-Q2") + as.ddur("P-3M"), as.FDate("2000-Q1"))

	expect_equal(as.FDate("2000-02") + as.ddur("ON"), as.FDate("2000-02-01"))
	expect_equal(as.FDate("2000-02") + as.ddur("P1M"), as.FDate("2000-H"))
	expect_equal(as.FDate("2000-02") + as.ddur("P1Y"), as.FDate("2001-02"))
	expect_equal(as.FDate("2000-02") - as.ddur("P1M"), as.FDate("2000-F"))
	expect_equal(as.FDate("2000-02") + as.ddur("P-1Y"), as.FDate("1999-02"))
})

test_that("FDate arith with integers", {
	expect_equal(as.FDate("2019-11-26") - 330L, as.FDate("2018-12-31"))
	expect_equal(as.FDate("2019-11-26") - 99L, as.FDate("2019-08-19"))
	expect_equal(as.FDate("2019-11-26") - 100L, as.FDate("2019-08-18"))
	expect_equal(as.FDate("2019-11-26") - -100L, as.FDate("2020-03-05"))
})

test_that("FDate trunc'ing", {
	expect_equal(trunc.FDate("2001-A", "y"), as.FDate("2001-A"))
	expect_equal(trunc.FDate("2001-S1", "y"), as.FDate("2001-A"))
	expect_equal(trunc.FDate("2001-S2", "y"), as.FDate("2001-A"))
	expect_equal(trunc.FDate("2001-Q3", "y"), as.FDate("2001-A"))
	expect_equal(trunc.FDate("2001-H", "y"), as.FDate("2001-A"))
	expect_equal(trunc.FDate("2001-03-03", "y"), as.FDate("2001-A"))

	expect_true(is.na(trunc.FDate("2001-A", "semi")))
	expect_equal(trunc.FDate("2001-S1", "semi"), as.FDate("2001-S1"))
	expect_equal(trunc.FDate("2001-S2", "semi"), as.FDate("2001-S2"))
	expect_equal(trunc.FDate("2001-Q3", "semi"), as.FDate("2001-S2"))
	expect_equal(trunc.FDate("2001-H", "semi"), as.FDate("2001-S1"))
	expect_equal(trunc.FDate("2001-12-03", "semi"), as.FDate("2001-S2"))

	expect_true(is.na(trunc.FDate("2001-A", "quarter")))
	expect_true(is.na(trunc.FDate("2001-S1", "quarter")))
	expect_true(is.na(trunc.FDate("2001-S2", "quarter")))
	expect_equal(trunc.FDate("2001-Q3", "quarter"), as.FDate("2001-Q3"))
	expect_equal(trunc.FDate("2001-H", "quarter"), as.FDate("2001-Q1"))
	expect_equal(trunc.FDate("2001-12-03", "quarter"), as.FDate("2001-Q4"))

	expect_true(is.na(trunc.FDate("2001-A", "month")))
	expect_true(is.na(trunc.FDate("2001-S1", "month")))
	expect_true(is.na(trunc.FDate("2001-S2", "month")))
	expect_true(is.na(trunc.FDate("2001-Q3", "month")))
	expect_equal(trunc.FDate("2001-H", "month"), as.FDate("2001-03"))
	expect_equal(trunc.FDate("2001-12-03", "month"), as.FDate("2001-12"))

	expect_true(is.na(trunc.FDate("2001-A", "week")))
	expect_true(is.na(trunc.FDate("2001-S1", "week")))
	expect_true(is.na(trunc.FDate("2001-S2", "week")))
	expect_true(is.na(trunc.FDate("2001-Q3", "week")))
	expect_true(is.na(trunc.FDate("2001-H", "week")))
	expect_equal(trunc.FDate("2001-12-03", "week"), as.FDate("2001-12-03"))
	expect_equal(trunc.FDate("2001-11-04", "week"), as.FDate("2001-10-29"))
})

test_that("ddur arith", {
	expect_equal(as.ddur("P0") + as.ddur("P2M"), as.ddur("P2M"))
	expect_equal(as.ddur("P2D") + as.ddur("P2M"), as.ddur("P2M2D"))
	expect_equal(as.ddur("P-1D") + as.ddur("P2M"), as.ddur("2M-1D"))
	expect_equal(as.ddur("P2D") - as.ddur("P2D"), ddur(0L))
	expect_equal(as.ddur("P2D") - as.ddur("P2M"), ddur("-2M2D"))
	expect_equal(-as.ddur("P-2M2D"), as.ddur("P2M-2D"))
	expect_true(is.na(as.ddur("AA") + as.ddur("P2M")))
	expect_true(is.na(as.ddur("TN") + as.ddur("XN")))
})

test_that("FDate->ddur arith", {
	expect_equal(as.FDate("2000-2-29") - as.FDate("2000-1-20"), ddur("P1M9D"))
	expect_equal(as.FDate("2000-2-29") - as.FDate("2001-1-20"), ddur("P-11M9D"))
	expect_equal(as.FDate("2000-2-29") - as.FDate("2000-2-10"), ddur(19L))
	expect_equal(as.FDate("2000-2-10") - as.FDate("2000-2-29"), ddur(-19L))
	expect_equal(as.FDate("2000-2-29") - as.FDate("2000-3-10"), ddur("P-1M19D"))
	expect_equal(as.FDate("2000-3-10") - as.FDate("2000-2-29"), ddur("P1M-19D"))
	expect_true(is.na(as.FDate("2000-2-29") - as.FDate("2001-1-32")))
	expect_true(is.na(as.FDate(NA_character_) - as.FDate("2001-1-20")))

	expect_equal(ddur(as.FDate("2000-2-29"),as.FDate("2000-3-10")), ddur(10L))
	expect_equal(ddur(as.FDate("2000-3-10"),as.FDate("2000-2-29")), ddur(-10L))
	expect_true(is.na(ddur(as.FDate(NA_character_), as.FDate("2001-1-20"))))

	expect_equal(as.FDate("2000-3-22") - as.FDate("2000-03-12"), as.ddur(10L))
	expect_equal(as.FDate("2000-3-12") - as.FDate("2000-03-22"), -ddur(10L))
	expect_equal(as.FDate("2000-3-22") - as.FDate("2000-02-12"), as.ddur("P1M10D"))
	expect_equal(as.FDate("2000-2-22") - as.FDate("2000-03-12"), as.ddur("P-1M10D"))
	expect_equal(as.FDate("2000-3-30") - as.FDate("1999-12-01"), as.ddur("P3M29D"))

	expect_equal(as.FDate("2000-3") - as.FDate("1999-12"), ddur("3M"))
	expect_equal(as.FDate("2000-Q3") - as.FDate("1999-Q4"), ddur("9M"))
	expect_equal(as.FDate("2000-S1") - as.FDate("1999-S2"), ddur("6M"))
	expect_equal(as.FDate("2000-A") - as.FDate("1999"), ddur("1Y"))
	expect_equal(as.FDate("2000-3") - as.FDate("1999-Q4"), ddur("5M"))
	expect_equal(as.FDate("2000-Q3") - as.FDate("1999-S2"), ddur("1Y"))
	expect_equal(as.FDate("2000-S2") - as.FDate("1999"), ddur("18M"))

	expect_equal(as.FDate("2000-3") - as.FDate("1999-12-12"), ddur("P4M-12D"))
	expect_equal(as.FDate("2000-Q3") - as.FDate("2000-02-29"), ddur("P8M-29D"))
	expect_equal(as.FDate("2000-S1") - as.FDate("1999-12-31"), ddur("P6M"))
	expect_equal(as.FDate("2000-A") - as.FDate("1999-11-31"), ddur("P1M1D"))

	expect_equal(ddur(as.FDate("1999-12-12"), as.FDate("2000-3")), ddur(79L))
	expect_equal(ddur(as.FDate("2000-02-29"), as.FDate("2000-Q3")), ddur("122D"))
	expect_equal(ddur(as.FDate("2000-03-12"), as.FDate("2000-3-22")), ddur(10L))
	expect_equal(ddur(as.FDate("2000-03-22"), as.FDate("2000-3-12")), -ddur(10L))
	expect_equal(ddur(as.FDate("2000-02-12"), as.FDate("2000-3-22")), ddur("P39D"))
	expect_equal(ddur(as.FDate("2000-03-12"), as.FDate("2000-2-22")), ddur("P-39D"))
	expect_equal(ddur(as.FDate("1999-12-01"), as.FDate("2000-3-30")), ddur("120D"))
})
